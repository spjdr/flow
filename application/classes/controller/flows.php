<?php defined('SYSPATH') or die('No direct script access.');class Controller_Flows extends Controller_Website {    	public function before()  	{  		$this->auth_required = 'login';  		parent::before();  	}  	/**	 * Index	 */	public function action_index()	{		$this->template->content = new View('flows/index');		$this->template->content->flows = $this->user->flows->find_all();	}		public function action_view()	{		$flow = ORM::factory('flow')->where('uri','=',Request::instance()->param('uri'))->find();			$content = $this->template->content = new View('flows/view');		$content->flow = $flow; 		$content->flow_users = ORM::factory('flow_user')->where('flow_id','=',$flow->id)->with('user')->order_by('master')->find_all();		$content->tags = $flow->tags->find_all();		$content->streams = $flow->streams->find_all();	}		public function action_new()	{		#Load the view		$this->template->title = $this->template->title.' - '.__('New flow');		$content = $this->template->content = View::factory('flows/new'); 		#If there is a post and $_POST is not empty		if ($_POST)		{			#Instantiate a new flow			$flow = ORM::factory('flow');							#Load the validation rules, filters etc...			$post = $_POST;			$post = $flow->validate_create($post);			 			#If the post data validates using the rules setup in the flow model			if ($post->check())			{				#Affects the sanitized vars to the flow object				$flow->values($post); 				#create the flow				$flow->save();								#Add the user to the flow				$this->user->add('flows',$flow,array('master'=>1));				 				#Add tags 				$tags = isset($_POST['tags']) ? array_unique($_POST['tags']) : array(); 				foreach($tags as $title) 				{ 					$tag = ORM::factory('tag'); 					$insert = array('flow_id'=>$flow->id,'title'=>$title); 					$insert = $tag->validate_create($insert); 					if ($insert->check()) 					{ 						$tag->values($insert); 						$tag->save(); 					} 				} 				 				$this->session->set('message',Kohana::message('flows','new_success')); 				#redirect to the flow				Request::instance()->redirect($flow->uri);			}			else			{				$this->session->set('error',Kohana::message('flows','new_failed'));								#Get errors for display in view				$content->errors = $post->errors('flows');				$content->post = $post;				$content->tags = isset($_POST['tags']) ? $_POST['tags'] : array();			}		}	}		public function action_edit()	{		$flow = ORM::factory('flow')->where('uri','=',Request::instance()->param('uri'))->find();			$this->template->title = __('Edit flow');		$content = $this->template->content = new View('flows/edit');		$content->flow = $flow;		$content->tags = $flow->tags->find_all();			#If there is a post and $_POST is not empty		if ($_POST)		{			#Load the validation rules, filters etc...			$post = $_POST;			$post = $flow->validate_edit($_POST);			 			#If the post data validates using the rules setup in the flow model			if ($post->check())			{				#Affects the sanitized vars to the flow object				$flow->values($post); 				#create the flow				$flow->save();								$this->session->set('message',Kohana::message('flows','edit_success')); 				#redirect to the flow				Request::instance()->redirect($flow->link);			}			else			{				$this->session->set('error',Kohana::message('flows','edit_failed'));								#Get errors for display in view				$content->errors = $post->errors('flows');				$content->post = $post;			}		}	}		public function action_delete()	{		$flow = ORM::factory('flow')->where('uri','=',Request::instance()->param('uri'))->find();			$content = $this->template->content = new View('flows/delete');		$content->flow = $flow;				$flow->delete();	}	}