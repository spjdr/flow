<?php defined('SYSPATH') or die('No direct script access.');class Controller_Users extends Controller_Website {    	public function before()  	{  		$this->auth_required = 'login';  		$this->restricted_actions = array('promote'=>array('master'),'degrade'=>array('master'));  		parent::before();  		$this->template->breadcrumbs = array();  		$this->template->breadcrumbs[] = html::anchor($this->flow->uri,html::chars($this->flow->title));  		  	}  	  	public function action_index()  	{					$this->template->title = __('Users');		$content = $this->template->content = new View('users/index');		$content->flow = $this->flow;		$content->flow_users = ORM::factory('flow_user')->with('user')->where('flow_id','=',$this->flow->id)->order_by('user.fullname','ASC')->find_all();		$content->access = $this->user->access[$this->flow->id];  	}  	  	public function action_view()  	{  		$user = ORM::factory('user')->where('username','=',Request::instance()->param('username'))->find();				if ($this->user->access[$this->flow->id]['master'] && $this->stream && Request::instance()->param('editee')=='appoint')  		{			$user->add('streams',$this->stream);  		}  		if ($this->user->access[$this->flow->id]['master'] && $this->stream && Request::instance()->param('editee')=='withdraw')  		{			$user->remove('streams',$this->stream);  		}		  		$this->template->title = html::chars($user->name);  				$this->template->breadcrumbs[] = html::anchor($this->flow->uri.'/users',__('Users'));	  	$content = $this->template->content = new View('users/view');		$content->access = $this->user->access[$this->flow->id];  	 	$content->user = $user;  		$content->flow = $this->flow;  		$content->flow_user = ORM::factory('flow_user')->where('user_id','=',$user->id)->where('flow_id','=',$this->flow->id)->find();  		  		$edits = array();  		foreach($user->streams->find_all() as $edit)  		{  			$edits[] = $edit->id;  		}  		  		$streams = array();  		foreach(ORM::factory('stream')->where('flow_id','=',$this->flow->id)->find_all() as $stream)  		{  			$streams[$stream->id] = $stream;  		}  		  		$content->edits = $edits;  		$content->streams = $streams;  	}  	  	public function action_promote()	{		$user = ORM::factory('user')->where('username','=',Request::instance()->param('username'))->find();		$this->template->title = __('Promote user');		$this->template->breadcrumbs[] = html::anchor($this->flow->uri.'/users',__('Users'));		$this->template->breadcrumbs[] = html::anchor($this->flow->uri.'/@'.$user->username,html::chars($user->name));			$content = $this->template->content = new View('users/promote');		$content->flow = $this->flow;		$content->user = $user;				if ($_POST)		{				if (isset($_POST['promote']))			{				$flow_user = ORM::factory('flow_user')->where('user_id','=',$user->id)->where('flow_id','=',$this->flow->id)->find();				$flow_user->master = 1;				$flow_user->save();							$this->session->set('message',Kohana::message('users','promote_success'));			} 			#redirect to the flo			Request::instance()->redirect($this->flow->uri.'/@'.$user->username);		}	}		public function action_degrade()	{		$user = ORM::factory('user')->where('username','=',Request::instance()->param('username'))->find();			$this->template->title = __('Degrade user');		$this->template->breadcrumbs[] = html::anchor($this->flow->uri.'/users',__('Users'));		$this->template->breadcrumbs[] = html::anchor($this->flow->uri.'/@'.$user->username,html::chars($user->name));		$content = $this->template->content = new View('users/degrade');		$content->flow = $this->flow;		$content->user = $user;				if ($_POST)		{				if (isset($_POST['degrade'])) 			{				$flow_user = ORM::factory('flow_user')->where('user_id','=',$user->id)->where('flow_id','=',$this->flow->id)->find();				$flow_user->master = 0;				$flow_user->save();							$this->session->set('message',Kohana::message('users','degrade_success')); 			} 						#redirect to the flow			Request::instance()->redirect($this->flow->uri.'/@'.$user->username);		}	}}