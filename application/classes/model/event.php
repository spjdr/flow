<?php defined('SYSPATH') or die('No direct script access.');class Model_Event extends ORM {  	protected $_has_many = array(		'tags' 		=> array('model' => 'tag', 'through' => 'events_tags'),	);		protected $_belongs_to = array(		'stream'	=> array('model'=>'stream')	);		protected $_rules = array(		'stream_id' => array(			'not_empty' 	=> NULL,			'regex' 		=> array('/[0-9]*/')		),		'title' => array(			'not_empty' => NULL,			'min_length' => array(4),			'max_length' => array(255)		),		'description' => array(			'not_empty' => NULL		),		'timestamp'	=> array(			'not_empty' => NULL,			'regex'		=> array('/[0-9]*/')		),		'duration' => array(			'not_empty'	=> NULL,			'regex'		=> array('/-?[0-9]{1,3}/')		),		'notes' => array(		),		'created_timestamp' => array(			'not_empty' => NULL		)	);		protected $_ignored_columns = array(		'date', 'tags'	);  	public function __get($key) 	{ 		switch($key) 		{ 			case 'durations': 				return Kohana::config('event')->get('durations'); 				break; 			default: 				return parent::__get($key); 		 		} 	} 	public function validate_create(& $array) 	{		// Initialise the validation library and setup some rules				$array = Validate::factory($array)						->rules('stream_id',$this->_rules['stream_id'])						->rules('title', $this->_rules['title'])						->rules('description', $this->_rules['description'])						->rules('timestamp', $this->_rules['timestamp'])						->rules('duration', $this->_rules['duration'])						->rules('notes', $this->_rules['notes'])						->filter('title', 'trim')						->filter('description', 'trim')						->filter('notes', 'trim'); 				return $array;	}		public function validate_edit(& $array)	{			// Initialise the validation library and setup some rules				$array = Validate::factory($array)						->rules('title', $this->_rules['title'])						->rules('description', $this->_rules['description'])						->rules('timestamp', $this->_rules['timestamp'])						->rules('duration', $this->_rules['duration'])						->rules('notes', $this->_rules['notes'])						->filter('title', 'trim')						->filter('description', 'trim')						->filter('notes', 'trim'); 				return $array;	}			/**	 * Tests if a unique key value exists in the database.	 *	 * @param   mixed    the value to test	 * @param   string   field name	 * @return  boolean	 */	public function unique_key_exists($value, $field)	{		return (bool) DB::select(array('COUNT("*")', 'total_count'))			->from($this->_table_name)			->where($field, '=', $value)			->where($this->_primary_key, '!=', $this->pk())			->execute($this->_db)			->get('total_count');	}		public function remove_all_tags()	{		return (bool) DB::delete('events_tags')			->where('event_id', '=', $this->pk())			->execute($this->_db);	}		public function save()	{		if (!parent::__isset('created_timestamp')) {			parent::__set('created_timestamp',time());		}				$cache = View::factory('models/event/html')->bind('event',$this)->render();		parent::__set('cache',$cache);				parent::save();	}		public function render($color,$flow,$stream,$tags=array())	{		if (!parent::__get('cache'))		{			$this->save();		}				$tokens = array_merge(array('{{color}}','{{flow}}','{{stream}}'),$tags['tokens']);		$values = array_merge(array($color,$flow,$stream),$tags['values']);				return str_replace($tokens,$values,parent::__get('cache'));	}}